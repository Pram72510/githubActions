name: CI/CD Jenkins-Style Pipeline

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Spring Boot JAR
        run: mvn clean package

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run unit tests
        run: mvn test

  deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vault CLI and dependencies
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com \$(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y vault ansible sshpass docker-compose

      - name: Fetch secrets from Vault
        run: |
          export VAULT_ADDR=\${{ secrets.VAULT_ADDR }}
          export VAULT_TOKEN=\${{ secrets.VAULT_TOKEN }}
          vault kv get -field=private_key secret/ssh > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          vault kv get -field=username secret/mysql > db_user.txt
          vault kv get -field=password secret/mysql > db_pass.txt

      - name: Start Docker containers
        run: docker-compose up --build -d

      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i hosts.ini mysql-install.yml \
            --extra-vars "db_user=\$(cat db_user.txt) db_pass=\$(cat db_pass.txt)"

      - name: Healthcheck
        run: curl --fail http://localhost:8081/dbcheck || exit 1
